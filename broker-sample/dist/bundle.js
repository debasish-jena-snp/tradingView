!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Brokers={})}(this,function(t){"use strict";var n=function(){return(n=Object.assign||function(t){for(var e,o=arguments,i=1,r=arguments.length;i<r;i++)for(var a in e=o[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)};function e(t,s,n,l){return new(n=n||Promise)(function(o,e){function i(t){try{a(l.next(t))}catch(t){e(t)}}function r(t){try{a(l.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?o(t.value):((e=t.value)instanceof n?e:new n(function(t){t(e)})).then(i,r)}a((l=l.apply(t,s||[])).next())})}function o(o,i){var r,a,s,n={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(r)throw new TypeError("Generator is already executing.");for(;n;)try{if(r=1,a&&(s=2&e[0]?a.return:e[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,e[1])).done)return s;switch(a=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return n.label++,{value:e[1],done:!1};case 5:n.label++,a=e[1],e=[0];continue;case 7:e=n.ops.pop(),n.trys.pop();continue;default:if(!(s=0<(s=n.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){n=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){n.label=e[1];break}if(6===e[0]&&n.label<s[1]){n.label=s[1],s=e;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(e);break}s[2]&&n.ops.pop(),n.trys.pop();continue}e=i.call(o,n)}catch(t){e=[6,t],a=0}finally{r=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var i=[{label:"Symbol",className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"symbol"},{label:"Side",className:"",property:"side",formatter:"side"},{label:"Type",className:"",property:"type",formatter:"type"},{label:"Qty",className:"tv-data-table__cell--right-align",property:"qty",help:"Size in lots"},{label:"Limit Price",className:"tv-data-table__cell--right-align",property:"limitPrice",formatter:"formatPrice"},{label:"Stop Price",className:"tv-data-table__cell--right-align",property:"stopPrice",formatter:"formatPrice"},{label:"Last",className:"tv-data-table__cell--right-align",property:"last",formatter:"formatPriceForexSup",highlightDiff:!0},{label:"Execution",className:"",property:"execution"},{id:"status",label:"Status",className:"",property:"status",formatter:"status",supportedStatusFilters:[0]},{label:"Order id",className:"",property:"id"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"orderSettings",notSortable:!0,modificationProperty:"status"}],r=[{label:"Symbol",className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"symbol"},{label:"Side",className:"",property:"side",formatter:"side"},{label:"Qty",className:"tv-data-table__cell--right-align",property:"qty",help:"Size in lots"},{label:"Avg Fill Price",className:"tv-data-table__cell--right-align",property:"avgPrice",formatter:"formatPrice"},{label:"Last",className:"tv-data-table__cell--right-align",property:"last",formatter:"formatPriceForexSup",highlightDiff:!0},{label:"Profit",className:"tv-data-table__cell--right-align",property:"pl",formatter:"profit"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"posSettings",notSortable:!0,modificationProperty:"status"}],a=[{label:"",notSortable:!0,property:"title",formatter:"custom_uppercase"},{label:"Balance",className:"tv-data-table__cell--right-align",property:"balance",formatter:"fixed",fixedWidth:!0},{label:"Open PL",className:"tv-data-table__cell--right-align",property:"pl",formatter:"profit",notSortable:!0,fixedWidth:!0},{label:"Equity",className:"tv-data-table__cell--right-align",property:"equity",formatter:"fixed",notSortable:!0,fixedWidth:!0}],s=(l.prototype.connectionStatus=function(){return 1},l.prototype.chartContextMenuActions=function(t,e){return this._host.defaultContextMenuActions(t)},l.prototype.isTradable=function(t){return Promise.resolve(!0)},l.prototype.placeOrder=function(e){var o=this;return function(t){e.duration&&console.log("Duration are not implemented in this sample."),o._host.activateBottomWidget();t={id:""+o._idsCounter++,duration:t.duration,limitPrice:t.limitPrice,profit:0,qty:t.qty,side:t.side||1,status:6,stopPrice:t.stopPrice,symbol:t.symbol,type:t.type||2,execution:t.customFields?t.customFields[2410]:"",takeProfit:t.takeProfit,stopLoss:t.stopLoss};return o._updateOrder(t),Promise.resolve()}(e)},l.prototype.modifyOrder=function(t){var e,o,i=this;return e=t,(o=i._orderById[e.id])&&((o=n({},o)).qty=e.qty,o.stopPrice=e.stopPrice,o.limitPrice=e.limitPrice,o.execution=e.customFields?e.customFields[2410]:"",i._updateOrder(o)),Promise.resolve()},l.prototype.editPositionBrackets=function(t,e){var o,i,r,a=this;return o=t,i=e,(r=a._positionById[o])&&((o=n({},r)).takeProfit=i&&i.takeProfit||r&&r.takeProfit||null,o.stopLoss=i&&i.stopLoss||r&&r.stopLoss||null,a._updatePosition(o)),Promise.resolve()},l.prototype.closePosition=function(t){var e=this,o=this._positionById[t];return e.placeOrder({symbol:o.symbol,side:-1===o.side?1:-1,type:2,qty:o.qty})},l.prototype.orders=function(){return Promise.resolve(this._orders.slice())},l.prototype.positions=function(){return Promise.resolve(this._positions.slice())},l.prototype.executions=function(e){return Promise.resolve(this._executions.filter(function(t){return t.symbol===e}))},l.prototype.reversePosition=function(t){var e=this,o=this._positionById[t];return e.placeOrder({symbol:o.symbol,side:-1===o.side?1:-1,type:2,qty:2*o.qty})},l.prototype.cancelOrder=function(t){var e=this,o=this._orderById[t];return o.status=1,e._updateOrder(o),Promise.resolve()},l.prototype.cancelOrders=function(t,e,o){var i=this;return Promise.all(o.map(function(t){return i.cancelOrder(t)})).then(function(){})},l.prototype.accountManagerInfo=function(){var o=this;return{accountTitle:"Trading Sample",summary:[{text:"Balance",wValue:this._balanceValue,formatter:"fixed"},{text:"Equity",wValue:this._equityValue,formatter:"fixed"}],customFormatters:[{name:"custom_uppercase",format:function(t){return String(t.value).toUpperCase()}}],orderColumns:i,positionColumns:r,pages:[{id:"accountsummary",title:"Account Summary",tables:[{id:"accountsummary",columns:a,getData:function(){return Promise.resolve([o._accountManagerData])},initialSorting:{columnId:"balance",asc:!1},changeDelegate:this._amChangeDelegate}]}],contextMenuActions:function(t,e){return Promise.resolve(o._bottomContextMenuItems(e))}}},l.prototype.symbolInfo=function(t){return this._host.symbolSnapshot(t).then(function(t){var e=t.minmov/t.pricescale;return{qty:{min:1,max:Number.MAX_VALUE,step:1},pipValue:e||1,pipSize:e,minTick:e,description:t.description}})},l.prototype.currentAccount=function(){return"1"},l.prototype.accountsMetainfo=function(){return e(this,void 0,void 0,function(){return o(this,function(t){return[2,[{id:"1",name:"Test account"}]]})})},l.prototype._bottomContextMenuItems=function(t){var e=this,o=this._host.sellBuyButtonsVisibility();return t.length&&t.push({separator:!0}),t.concat([{text:"Show Buy/Sell Buttons",action:function(){o&&o.setValue(!o.value())},checkable:!0,checked:null!==o&&o.value()},{text:"Trading Settings...",action:function(){e._host.showTradingProperties()}}])},l.prototype._buttonDropdownItems=function(){var t=this;return this._host.defaultDropdownMenuActions({showSellBuyButtons:!0,showOrderPanel:!0}).concat([{separator:!0},{text:"Trading Settings...",action:function(){t._host.showTradingProperties()}}])},l.prototype._createPositionForOrder=function(t){var e,o,i=t.symbol,r=this._positionById[i],a=t.side,s=t.qty;t.avgPrice=t.price,r?(0<(e=t.side===r.side?1:-1)?r.avgPrice=(r.qty*r.avgPrice+t.qty*t.price)/(r.qty+t.qty):(r.avgPrice=r.avgPrice,o=Math.min(s,r.qty),this._accountManagerData.balance+=(t.price-r.avgPrice)*o*(-1===r.side?-1:1)),r.qty=r.qty+t.qty*e,r.qty<0&&(r.side=-1===r.side?1:-1,r.qty*=-1)):r=n(n({},t),{id:i,avgPrice:t.price});t={id:""+this._idsCounter++,brokerSymbol:t.brokerSymbol,price:t.price,qty:s,side:a,symbol:t.symbol,time:Date.now()};this._executions.push(t),this._host.executionUpdate(t),this._updatePosition(r),this._recalculateAMData()},l.prototype._updateOrderLast=function(t){this._host.orderPartialUpdate(t.id,{last:t.last})},l.prototype._updateOrder=function(e){var t,o=this,i=((r={})[-1]=((t={})[2]=function(){return!!e.price},t[1]=function(){return void 0!==e.limitPrice&&e.last>=e.limitPrice},t[3]=function(){return void 0!==e.stopPrice&&e.last<=e.stopPrice},t[4]=function(){return!1},t),r[1]=((t={})[2]=function(){return!!e.price},t[1]=function(){return void 0!==e.limitPrice&&e.last<=e.limitPrice},t[3]=function(){return void 0!==e.stopPrice&&e.last>=e.stopPrice},t[4]=function(){return!1},t),r),r=Boolean(this._orderById[e.id]);this._orderById[e.id]=e,r||(this._orders.push(e),this._subscribeData(e.symbol,e.id,function(t){e.last!==t&&(e.last=t,null==e.price&&(e.price=e.last),6===e.status&&i[e.side][e.type]()&&(delete(t=n({},e)).status,e.price=e.last,e.avgPrice=e.last,o._createPositionForOrder(t),e.status=2,o._updateOrder(e)),o._updateOrderLast(e))})),this._host.orderUpdate(e)},l.prototype._updatePosition=function(e){var o=this,t=Boolean(this._positionById[e.id]);if(t&&!e.qty){this._unsubscribeData(e.id);var i=this._positions.indexOf(e);return-1!==i&&this._positions.splice(i,1),delete this._positionById[e.id],void this._host.positionUpdate(e)}t||(this._positions.push(e),this._subscribeData(e.symbol,e.id,function(t){e.last!==t&&(e.last=t,e.profit=(e.last-e.price)*e.qty*(-1===e.side?-1:1),o._host.plUpdate(e.symbol,e.profit),o._host.positionPartialUpdate(e.id,e),o._recalculateAMData())})),this._positionById[e.id]=e,this._host.positionUpdate(e)},l.prototype._subscribeData=function(t,e,o){this._quotesProvider.subscribeQuotes([],[t],function(t){t=t[0];"ok"===t.s&&"number"==typeof t.v.lp&&o(t.v.lp)},c(e))},l.prototype._unsubscribeData=function(t){this._quotesProvider.unsubscribeQuotes(c(t))},l.prototype._recalculateAMData=function(){var e=0;this._positions.forEach(function(t){e+=t.profit||0}),this._accountManagerData.pl=e,this._accountManagerData.equity=this._accountManagerData.balance+e,this._amChangeDelegate.fire(this._accountManagerData)},l);function l(t,e){var o=this;this._accountManagerData={title:"Trading Sample",balance:1e7,equity:1e7,pl:0},this._positionById={},this._positions=[],this._orderById={},this._orders=[],this._executions=[],this._idsCounter=1,this._quotesProvider=e,this._host=t,this._host.setButtonDropdownActions(this._buttonDropdownItems());t=this._host.sellBuyButtonsVisibility();null!==t&&t.subscribe(function(){o._host.setButtonDropdownActions(o._buttonDropdownItems())});t=this._host.domPanelVisibility();t&&t.subscribe(function(){o._host.setButtonDropdownActions(o._buttonDropdownItems())});t=this._host.orderPanelVisibility();t&&t.subscribe(function(){o._host.setButtonDropdownActions(o._buttonDropdownItems())}),this._amChangeDelegate=this._host.factory.createDelegate(),this._balanceValue=this._host.factory.createWatchedValue(this._accountManagerData.balance),this._equityValue=this._host.factory.createWatchedValue(this._accountManagerData.equity),this._amChangeDelegate.subscribe(null,function(t){o._balanceValue.setValue(t.balance),o._equityValue.setValue(t.equity)})}function c(t){return"SampleBroker-"+t}t.BrokerSample=s,Object.defineProperty(t,"__esModule",{value:!0})});
