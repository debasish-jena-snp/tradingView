!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Datafeeds={})}(this,(function(t){"use strict";var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,r)};function r(t,r){function s(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(s.prototype=r.prototype,new s)}function s(t){return void 0===t?"":"string"==typeof t?t:t.message}var o,n,i=function(){function t(t,e){this._datafeedUrl=t,this._requester=e}return t.prototype.getBars=function(t,e,r,o){var n=this,i={symbol:t.ticker||"",resolution:e,from:r,to:o};return void 0!==t.currency_code&&(i.currencyCode=t.currency_code),new Promise((function(t,e){n._requester.sendRequest(n._datafeedUrl,"history",i).then((function(r){if("ok"===r.s||"no_data"===r.s){var s=[],o={noData:!1};if("no_data"===r.s)o.noData=!0,o.nextTime=r.nextTime;else for(var n=void 0!==r.v,i=void 0!==r.o,a=0;a<r.t.length;++a){var u={time:1e3*r.t[a],close:parseFloat(r.c[a]),open:parseFloat(r.c[a]),high:parseFloat(r.c[a]),low:parseFloat(r.c[a])};i&&(u.open=parseFloat(r.o[a]),u.high=parseFloat(r.h[a]),u.low=parseFloat(r.l[a])),n&&(u.volume=parseFloat(r.v[a])),s.push(u)}t({bars:s,meta:o})}else e(r.errmsg)})).catch((function(t){var r=s(t);console.warn("HistoryProvider: getBars() failed, error="+r),e(r)}))}))},t}(),a=function(){function t(t,e){this._subscribers={},this._requestsPending=0,this._historyProvider=t,setInterval(this._updateData.bind(this),e)}return t.prototype.subscribeBars=function(t,e,r,s){this._subscribers.hasOwnProperty(s)||(this._subscribers[s]={lastBarTime:null,listener:r,resolution:e,symbolInfo:t},t.name)},t.prototype.unsubscribeBars=function(t){delete this._subscribers[t]},t.prototype._updateData=function(){var t=this;if(!(this._requestsPending>0)){this._requestsPending=0;var e=function(e){r._requestsPending+=1,r._updateDataForSubscriber(e).then((function(){t._requestsPending-=1,t._requestsPending})).catch((function(e){t._requestsPending-=1,s(e),t._requestsPending}))},r=this;for(var o in this._subscribers)e(o)}},t.prototype._updateDataForSubscriber=function(t){var e=this,r=this._subscribers[t],s=parseInt((Date.now()/1e3).toString()),o=s-function(t,e){var r=0;r="D"===t||"1D"===t?e:"M"===t||"1M"===t?31*e:"W"===t||"1W"===t?7*e:e*parseInt(t)/1440;return 24*r*60*60}(r.resolution,10);return this._historyProvider.getBars(r.symbolInfo,r.resolution,o,s).then((function(r){e._onSubscriberDataReceived(t,r)}))},t.prototype._onSubscriberDataReceived=function(t,e){if(this._subscribers.hasOwnProperty(t)){var r=e.bars;if(0!==r.length){var s=r[r.length-1],o=this._subscribers[t];if(!(null!==o.lastBarTime&&s.time<o.lastBarTime)){if(null!==o.lastBarTime&&s.time>o.lastBarTime){if(r.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");var n=r[r.length-2];o.listener(n)}o.lastBarTime=s.time,o.listener(s)}}}},t}();!function(t){t[t.General=0]="General",t[t.Fast=1]="Fast"}(o||(o={})),function(t){t[t.Fast=1e4]="Fast",t[t.General=6e4]="General"}(n||(n={}));var u=function(){function t(t){this._subscribers={},this._requestsPending=0,this._quotesProvider=t,setInterval(this._updateQuotes.bind(this,o.Fast),n.Fast),setInterval(this._updateQuotes.bind(this,o.General),n.General)}return t.prototype.subscribeQuotes=function(t,e,r,s){this._subscribers[s]={symbols:t,fastSymbols:e,listener:r}},t.prototype.unsubscribeQuotes=function(t){delete this._subscribers[t]},t.prototype._updateQuotes=function(t){var e=this;if(!(this._requestsPending>0)){var r=function(r){n._requestsPending++;var i=n._subscribers[r];n._quotesProvider.getQuotes(t===o.Fast?i.fastSymbols:i.symbols).then((function(t){e._requestsPending--,e._subscribers.hasOwnProperty(r)&&(i.listener(t),e._requestsPending)})).catch((function(t){e._requestsPending--,s(t),e._requestsPending}))},n=this;for(var i in this._subscribers)r(i)}},t}();function c(t,e,r,s){var o=t[e];return!Array.isArray(o)||s&&!Array.isArray(o[0])?o:o[r]}function h(t,e){return t+(void 0!==e?"_%|#|%_"+e:"")}var l,f=function(){function t(t,e,r){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=t,this._datafeedSupportedResolutions=e,this._requester=r,this._readyPromise=this._init(),this._readyPromise.catch((function(t){console.error("SymbolsStorage: Cannot init, error="+t.toString())}))}return t.prototype.resolveSymbol=function(t,e){var r=this;return this._readyPromise.then((function(){var s=r._symbolsInfo[h(t,e)];return void 0===s?Promise.reject("invalid symbol"):Promise.resolve(s)}))},t.prototype.searchSymbols=function(t,e,r,s){var o=this;return this._readyPromise.then((function(){var n=[],i=0===t.length;t=t.toUpperCase();for(var a=function(s){var a=o._symbolsInfo[s];if(void 0===a)return"continue";if(r.length>0&&a.type!==r)return"continue";if(e&&e.length>0&&a.exchange!==e)return"continue";var u=a.name.toUpperCase().indexOf(t),c=a.description.toUpperCase().indexOf(t);if((i||u>=0||c>=0)&&!n.some((function(t){return t.symbolInfo===a}))){var h=u>=0?u:8e3+c;n.push({symbolInfo:a,weight:h})}},u=0,c=o._symbolsList;u<c.length;u++){a(c[u])}var h=n.sort((function(t,e){return t.weight-e.weight})).slice(0,s).map((function(t){var e=t.symbolInfo;return{symbol:e.name,full_name:e.full_name,description:e.description,exchange:e.exchange,params:[],type:e.type,ticker:e.name}}));return Promise.resolve(h)}))},t.prototype._init=function(){for(var t=this,e=[],r={},s=0,o=this._exchangesList;s<o.length;s++){var n=o[s];r[n]||(r[n]=!0,e.push(this._requestExchangeData(n)))}return Promise.all(e).then((function(){t._symbolsList.sort()}))},t.prototype._requestExchangeData=function(t){var e=this;return new Promise((function(r,o){e._requester.sendRequest(e._datafeedUrl,"symbol_info",{group:t}).then((function(s){try{e._onExchangeDataReceived(t,s)}catch(n){return void o(n)}r()})).catch((function(t){s(t),r()}))}))},t.prototype._onExchangeDataReceived=function(t,e){var r=0;try{for(var s=e.symbol.length,o=void 0!==e.ticker;r<s;++r){var n=e.symbol[r],i=c(e,"exchange-listed",r),a=c(e,"exchange-traded",r),u=a+":"+n,l=c(e,"currency-code",r),f=o?c(e,"ticker",r):n,_={ticker:f,name:n,base_name:[i+":"+n],full_name:u,listed_exchange:i,exchange:a,currency_code:l,original_currency_code:c(e,"original-currency-code",r),description:c(e,"description",r),has_intraday:p(c(e,"has-intraday",r),!1),has_no_volume:p(c(e,"has-no-volume",r),!1),minmov:c(e,"minmovement",r)||c(e,"minmov",r)||0,minmove2:c(e,"minmove2",r)||c(e,"minmov2",r),fractional:c(e,"fractional",r),pricescale:c(e,"pricescale",r),type:c(e,"type",r),session:c(e,"session-regular",r),timezone:c(e,"timezone",r),supported_resolutions:p(c(e,"supported-resolutions",r,!0),this._datafeedSupportedResolutions),force_session_rebuild:c(e,"force-session-rebuild",r),has_daily:p(c(e,"has-daily",r),!0),intraday_multipliers:p(c(e,"intraday-multipliers",r,!0),["1","5","15","30","60"]),has_weekly_and_monthly:c(e,"has-weekly-and-monthly",r),has_empty_bars:c(e,"has-empty-bars",r),volume_precision:p(c(e,"volume-precision",r),0),format:"price"};this._symbolsInfo[f]=_,this._symbolsInfo[n]=_,this._symbolsInfo[u]=_,void 0!==l&&(this._symbolsInfo[h(f,l)]=_,this._symbolsInfo[h(n,l)]=_,this._symbolsInfo[h(u,l)]=_),this._symbolsList.push(n)}}catch(d){throw new Error("SymbolsStorage: API error when processing exchange "+t+" symbol #"+r+" ("+e.symbol[r]+"): "+d.message)}},t}();function p(t,e){return void 0!==t?t:e}function _(t,e,r){var s=t[e];return Array.isArray(s)?s[r]:s}!function(t){t[t.SearchItemsLimit=30]="SearchItemsLimit"}(l||(l={}));var d=function(){function t(t,e,r,s){var o=this;void 0===s&&(s=1e4),this._configuration={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1},this._symbolsStorage=null,this._datafeedURL=t,this._requester=r,this._historyProvider=new i(t,this._requester),this._quotesProvider=e,this._dataPulseProvider=new a(this._historyProvider,s),this._quotesPulseProvider=new u(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then((function(t){null===t&&(t={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}),o._setupWithConfiguration(t)}))}return t.prototype.onReady=function(t){var e=this;this._configurationReadyPromise.then((function(){t(e._configuration)}))},t.prototype.getQuotes=function(t,e,r){this._quotesProvider.getQuotes(t).then(e).catch(r)},t.prototype.subscribeQuotes=function(t,e,r,s){this._quotesPulseProvider.subscribeQuotes(t,e,r,s)},t.prototype.unsubscribeQuotes=function(t){this._quotesPulseProvider.unsubscribeQuotes(t)},t.prototype.calculateHistoryDepth=function(t,e,r){},t.prototype.getMarks=function(t,e,r,o,n){if(this._configuration.supports_marks){var i={symbol:t.ticker||"",from:e,to:r,resolution:n};this._send("marks",i).then((function(t){if(!Array.isArray(t)){for(var e=[],r=0;r<t.id.length;++r)e.push({id:_(t,"id",r),time:_(t,"time",r),color:_(t,"color",r),text:_(t,"text",r),label:_(t,"label",r),labelFontColor:_(t,"labelFontColor",r),minSize:_(t,"minSize",r)});t=e}o(t)})).catch((function(t){s(t),o([])}))}},t.prototype.getTimescaleMarks=function(t,e,r,o,n){if(this._configuration.supports_timescale_marks){var i={symbol:t.ticker||"",from:e,to:r,resolution:n};this._send("timescale_marks",i).then((function(t){if(!Array.isArray(t)){for(var e=[],r=0;r<t.id.length;++r)e.push({id:_(t,"id",r),time:_(t,"time",r),color:_(t,"color",r),label:_(t,"label",r),tooltip:_(t,"tooltip",r)});t=e}o(t)})).catch((function(t){s(t),o([])}))}},t.prototype.getServerTime=function(t){this._configuration.supports_time&&this._send("time").then((function(e){var r=parseInt(e);isNaN(r)||t(r)})).catch((function(t){s(t)}))},t.prototype.searchSymbols=function(t,e,r,o){if(this._configuration.supports_search){var n={limit:l.SearchItemsLimit,query:t.toUpperCase(),type:r,exchange:e};this._send("search",n).then((function(t){if(void 0!==t.s)return t.errmsg,void o([]);o(t)})).catch((function(t){s(t),o([])}))}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(t,e,r,l.SearchItemsLimit).then(o).catch(o.bind(null,[]))}},t.prototype.resolveSymbol=function(t,e,r,o){var n=o&&o.currencyCode;function i(t){e(t)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(t,n).then(i).catch(r)}else{var a={symbol:t};void 0!==n&&(a.currencyCode=n),this._send("symbols",a).then((function(t){void 0!==t.s?r("unknown_symbol"):i(t)})).catch((function(t){s(t),r("unknown_symbol")}))}},t.prototype.getBars=function(t,e,r,s,o,n){this._historyProvider.getBars(t,e,r,s).then((function(t){o(t.bars,t.meta)})).catch(n)},t.prototype.subscribeBars=function(t,e,r,s,o){this._dataPulseProvider.subscribeBars(t,e,r,s)},t.prototype.unsubscribeBars=function(t){this._dataPulseProvider.unsubscribeBars(t)},t.prototype._requestConfiguration=function(){return this._send("config").catch((function(t){return s(t),null}))},t.prototype._send=function(t,e){return this._requester.sendRequest(this._datafeedURL,t,e)},t.prototype._setupWithConfiguration=function(t){if(this._configuration=t,void 0===t.exchanges&&(t.exchanges=[]),!t.supports_search&&!t.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!t.supports_group_request&&t.supports_search||(this._symbolsStorage=new f(this._datafeedURL,t.supported_resolutions||[],this._requester)),JSON.stringify(t)},t}();var m=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.getQuotes=function(e){return t.prototype.getQuotes.call(this,e).then((function(t){return t.forEach((function(t){"ok"===t.s&&(t.v.short_name=t.n,t.v.description=t.n)})),t}))},e}(function(){function t(t,e){this._datafeedUrl=t,this._requester=e}return t.prototype.getQuotes=function(t){var e=this;return new Promise((function(r,o){e._requester.sendRequest(e._datafeedUrl,"quotes",{symbols:t}).then((function(t){"ok"===t.s?r(t.d):o(t.errmsg)})).catch((function(t){var e=s(t);o("network error: "+e)}))}))},t}()),y=function(){function t(t){t&&(this._headers=t)}return t.prototype.sendRequest=function(t,e,r){if(void 0!==r){var s=Object.keys(r);0!==s.length&&(e+="?"),e+=s.map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(r[t].toString())})).join("&")}var o={credentials:"same-origin"};return void 0!==this._headers&&(o.headers=this._headers),fetch(t+"/"+e,o).then((function(t){return t.text()})).then((function(t){return JSON.parse(t)}))},t}(),b=function(t){function e(e,r,s,o){void 0===o&&(o=1e4);var n=this,i=new y({Authorization:"Bearer "+r});return(n=t.call(this,e,new m(e,i),i,o)||this)._configuration=s,n._configuration.supports_group_request=!0,n}return r(e,t),e.prototype._requestConfiguration=function(){var t=this;return new Promise((function(e){setTimeout((function(){e(t._configuration)}))}))},e}(d);t.RestUDFCompatibleDatafeed=b,Object.defineProperty(t,"__esModule",{value:!0})}));
